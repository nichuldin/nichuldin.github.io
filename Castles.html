<html>
	<head>
		<title>Castles_game</title>
		<style>
			html, body {
				overflow: hidden;
        margin: 0;
        padding: 0;
			}
		</style>
	</head>
  <body onresize="resizeCanvas()">
		<canvas id="mainCanvas">
		</canvas>
		<script>
			function resizeCanvas() {
				canvas.width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				canvas.height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
				
				WIDTH = canvas.width;
				HEIGHT = canvas.height;
				
				clearScreen();
			}
			function clearScreen() {
				ctx.fillStyle = '#18192b';
				ctx.fillRect(0, 0, WIDTH, HEIGHT);
      }
      function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        if (typeof stroke == 'undefined') {
          stroke = true;
        }
        if (typeof radius === 'undefined') {
          radius = 5;
        }
        if (typeof radius === 'number') {
          radius = {tl: radius, tr: radius, br: radius, bl: radius};
        } else {
          var defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
          for (var side in defaultRadius) {
            radius[side] = radius[side] || defaultRadius[side];
          }
        }
        ctx.beginPath();
        ctx.moveTo(x + radius.tl, y);
        ctx.lineTo(x + width - radius.tr, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
        ctx.lineTo(x + width, y + height - radius.br);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
        ctx.lineTo(x + radius.bl, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
        ctx.lineTo(x, y + radius.tl);
        ctx.quadraticCurveTo(x, y, x + radius.tl, y);
        ctx.closePath();
        if (fill) {
          ctx.fill();
        }
        if (stroke) {
          ctx.stroke();
        }

      }
      
      canvas = document.getElementById('mainCanvas');
      ctx = canvas.getContext("2d");
      
      canvas.width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      canvas.height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
      WIDTH	= canvas.width;
      HEIGHT	= canvas.height;
      clearScreen();

      locate = window.location.href;
      var re = locate.split("?");
      var user_id = re[1];
      var user_token = re[2].split("#")[0];
      var gamephase = 0;
      var link_base = 'https://58978b3c96d8.ngrok.io';
      var link = link_base + '/balance/'+user_id+'%3A'+user_token;
      var link_action = link_base + '/castles_check_search/'+user_id+'%3A'+user_token;
      var link_queue = link_base + '/castles_start_search/'+user_id+'%3A'+user_token;
      var num_of_soldiers = {red: 100, blue: 100};
      var dots = 0;
      var BackGroundSizeX = canvas.height*0.5625;
      var BackGroundSizeY = canvas.height;
      var BackGroundX = canvas.width/2 - BackGroundSizeX/2;
      var BackGroundY = 0;
      if (canvas.width < BackGroundSizeX * 1.2)
      {
        BackGroundSizeX = canvas.width;
        BackGroundX = 0;
      }
      var balance_params = {x:canvas.width/2 + BackGroundSizeX/2, y:canvas.height*0.02, text_size: canvas.height/30};
      var border_size = canvas.height/80;
      var angles_x = [30, 20, -30, 16, -17, 8, 30, 15, -30, 5, -7, 30, 5];
      var angles_y = [4, -30, -28, 30, -30, 30, 21, -30, -20, 30, -30, 6, -30];
      var rect_width = 200;
      var rect_height = 70;

      var rect_dice_width = canvas.height/14;
      var rect_dice_height = rect_dice_width;

      var rect_width = rect_dice_width * 4;
      var rect_height = rect_dice_width;
      
      var rect_attack_height = canvas.height/7;
      var rect_attack_width = BackGroundSizeX * 0.9;

     

      var Waiter = 0, Waiter_attack = 0, Waiter_collect = 0, Waiter_battle = 0;
      var Timer_size = canvas.height/16;
      var WaitTimeout5;
      var bat_size = canvas.height/30;
      var rect = {x:canvas.width/2-rect_width/2, y:canvas.height/2 - rect_height/2, width:rect_width, height:rect_height};
      var rect_single = {x:canvas.width/2-rect_width/2, y:canvas.height/2 + rect_height/1.3, width:rect_width, height:rect_height};
      var rect_10 = {x:canvas.width/2-rect_width/2, y:canvas.height/2 - rect.height*1.7, width:rect_dice_width, height:rect_dice_height};
      var rect_50 = {x:canvas.width/2-rect_dice_width*0.75, y:rect_10.y, width:rect_dice_width, height:rect_dice_height};
      var rect_100 = {x:canvas.width/2+rect_width/2-rect_dice_width*1.5, y:rect_10.y, width:rect_dice_width*1.5, height:rect_dice_height};
      var rect_bat_height = 100;
      var rect_bat_width = 350;
      var rect_search = {x:canvas.width/2-BackGroundSizeX*0.4, y:canvas.height/2 - rect_height/2, width:BackGroundSizeX*0.8, height:rect_height};
      var rect_attack = {x:canvas.width/2-rect_attack_width/2, y:canvas.height/2 - rect_attack_height/2, width:rect_attack_width, height:rect_attack_height};
      var rect_num_of_soldiers = {x:rect_attack.x, y:canvas.height*7/9, width:rect_attack.width, height:rect_attack.height};
      var slider_soldiers = {x:rect_num_of_soldiers.x + rect_num_of_soldiers.width*0.05, y:canvas.height*0.84, width:rect_num_of_soldiers.width*0.75, height:canvas.height/20};
      var bat = 0;
      var red_army = {x:canvas.width/2-BackGroundSizeX/2 * 0.6, y:canvas.height*3/4, size:canvas.height/22};
      var blue_army = {x:canvas.width/2-BackGroundSizeX/2 * 0.9, y:canvas.height/5, size:canvas.height/22};
      var num_of_soldiers_current = {red: 0, blue: 0};
      var forts_capture = [0, 0, 0];
      var warrior_red = new Image();
      var warrior_blue = new Image();
      var balance = "";
      var fort = new Image();
      var pool = new Image();
      var end_point = {x: 0, y: 0};
      var start_seconds = 0;
      var text_hight = canvas.height/30;
      var fort_red = new Image();
      var arrow_rigth = new Image();
      var arrow_left = new Image();
      var arrow_forward = new Image();
      var fort_blue = new Image();
      var attack_on = 0;
      var start_time = 0;
      var evry_5_sec = 0;
      var opponent_name = "";
      var fort_size = {x: canvas.height/8, y: canvas.height/5};
      var fort1 = {x: BackGroundX+BackGroundSizeX/6-fort_size.x/2, y: canvas.height/2-fort_size.y/2};
      var fort2 = {x: (canvas.width-fort_size.x)/2, y: canvas.height/2-fort_size.y/2};
      var fort3 = {x: BackGroundX+BackGroundSizeX*5/6-fort_size.x/2, y: canvas.height/2-fort_size.y/2};
      var Timer_pos = {x: rect_attack.x + rect_attack.width - Timer_size*1.1, y: rect_attack.y + Timer_size*1.1};
      var big_soldier_red = {x: 0, y: 0, size_x: 0, size_y: 0};
      var big_soldier_blue = {x: 0, y: 0, size_x: 0, size_y: 0};
      pool.src="pool.png"; pool.addEventListener("load", function(){ 
      fort.src="fort.png"; fort.addEventListener("load", function(){ 
      warrior_blue.src="warrior_blue.png"; warrior_blue.addEventListener("load", function(){
      warrior_red.src="warrior_red.png"; warrior_red.addEventListener("load", function(){
      fort_red.src="fort_red.png"; fort_red.addEventListener("load", function(){
      arrow_rigth.src="arrow_rigth.png"; arrow_rigth.addEventListener("load", function(){
      arrow_left.src="arrow_left.png"; arrow_left.addEventListener("load", function(){
      arrow_forward.src="arrow_forward.png"; arrow_forward.addEventListener("load", function(){
      fort_blue.src="fort_blue.png"; fort_blue.addEventListener("load", function(){start();}, false);}, false);}, false);}, false);}, false);}, false);}, false);}, false);}, false);
      function draw_n_soldiers_red(cord_x, cord_y, sold_size, from, to){
        var step;
        var step1;
        for (step = 0; step < 10; step++){
          for (step1 = 0; step1 < to/10; step1++){
            if(step + step1*10 < to && step + step1*10 >= from)
              ctx.drawImage(warrior_red,cord_x + step*(BackGroundSizeX/15),cord_y + step1*(BackGroundSizeY/35), red_army.size, red_army.size/7*11);
          }
        }  
      }
      function draw_n_soldiers_blue(cord_x, cord_y, sold_size, from, to){
        var step;
        var step1;
        for (step = 9; step >= 0; step-=1){
          for (step1 = 0; step1 <= to/10; step1+=1){
            if(step + step1*10 >= 10-to%10 && step + step1*10 < parseInt(num_of_soldiers.blue/10+1)*10-from)
              ctx.drawImage(warrior_blue,cord_x + step*(BackGroundSizeX/15),cord_y - parseInt(to/10)*(BackGroundSizeY/35)+ step1*(BackGroundSizeY/35), blue_army.size, blue_army.size/7*11);
          }
        }
      }
      function draw_balance(update){
        if(update == true)
        {
          var promise = new Promise(function(resolve, reject) 
          {
            fetch(link).then((response) => {return response.json();}).then((data) => 
            {
              balance = data.data + "р";
              draw_balance(false);
            });
          });
        }
        else
        { 
          ctx.lineWidth = bat_size/20;
          ctx.font = 'bold '+balance_params.text_size+'px Helvetica, Arial';
          ctx.fillStyle = "#facc00";
          roundRect(ctx, (canvas.width - BackGroundSizeX)/2, -border_size*3, BackGroundSizeX, canvas.height*0.1, {tl: border_size*3, br: border_size*3, tr:border_size*3, bl:border_size*3}, true);
          ctx.fillStyle = "white";
          ctx.fillText(balance,balance_params.x-ctx.measureText(balance).width*1.1, balance_params.y+balance_params.text_size/1.5);
          //ctx.strokeStyle = "black";
          //ctx.lineWidth = balance_params.text_size/25;
          //ctx.strokeText(balance,balance_params.x-ctx.measureText(balance).width*1.1, balance_params.y+balance_params.text_size/1.5);
          if(gamephase > 3)
          {
            ctx.font = 'bold '+bat_size+'px Helvetica, Arial';
            ctx.fillStyle = "white";
            text = "Противник: " + opponent_name;
            ctx.fillText(text,(BackGroundSizeX - ctx.measureText(text).width)/2, canvas.height*0.04);
          }
        }
      }  
      function start(){
        forts_capture[0] = 0;
        forts_capture[1] = 0;
        forts_capture[2] = 0;
        num_of_soldiers.red = 100; num_of_soldiers.blue = 100;
        ctx.drawImage(pool, BackGroundX, BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        draw_balance(true);
        ctx.fillStyle = "#facc00";
        ctx.lineWidth = bat_size/10;
        roundRect(ctx, rect.x, rect.y, rect.width, rect.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        roundRect(ctx, rect_single.x, rect_single.y, rect_single.width, rect_single.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        draw_bat(ctx, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2);
        ctx.font = 'bold '+canvas.height/25+'px Helvetica, Arial';
        ctx.fillStyle = "purple";
        var text = "Играть дуэль";
        ctx.fillText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*0.7);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*0.7);


        ctx.font = 'bold '+canvas.height/32+'px Helvetica, Arial';
        var text = "Играть против ИИ";
        ctx.fillText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*1.95);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*1.95);
        ctx.font = 'bold '+canvas.height/20+'px Helvetica, Arial';
  
        ctx.fillStyle = "purple";
        text4 = "Сделайте ставку";
        ctx.fillText(text4,rect.x + (rect.width - ctx.measureText(text4).width)/2, rect.y - rect.height*1.5);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text4,rect.x + (rect.width - ctx.measureText(text4).width)/2, rect.y - rect.height*1.5);
      }
      function start_search(){
        var promise = new Promise(function(resolve, reject) 
          {
            fetch(link_queue + '%3A' + bat).then((response) => {return response.json();}).then((data) => 
            {
              ;
            });
          });
      }
      function search(){
        dots++;
        if(dots % 10 == 0){
          var promise = new Promise(function(resolve, reject) 
          {
            fetch(link_action + '%3A' + bat).then((response) => {return response.json();}).then((data) => 
            {
              if(data.data == "true")
              {
                opponent_name = data.opponent_name;
                start_time = Date.now() + data.time;
                clearTimeout(WaitTimeout5);
                Wait_duel_start();
                return;
              }
            });
          });
        }
        ctx.fillStyle = "#facc00";
        roundRect(ctx, rect_single.x, rect_single.y, rect_single.width, rect_single.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        ctx.fillStyle = "purple";
        ctx.font = 'bold '+canvas.height/25+'px Helvetica, Arial';
        var text = "Отмена";
        ctx.fillText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*1.95);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text,rect.x + (rect.width - ctx.measureText(text).width)/2, rect.y + rect.height*1.95);
        ctx.font = 'bold '+canvas.height/20+'px Helvetica, Arial';

        draw_balance(false);
        ctx.fillStyle = "#facc00";
        ctx.lineWidth = bat_size/10;
        roundRect(ctx, rect_search.x, rect_search.y, rect_search.width, rect_search.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        draw_bat(ctx, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2);
        ctx.font = 'bold '+canvas.height/25+'px Helvetica, Arial';
        ctx.fillStyle = "white";
        var text = "Поиск противника";
        var text1 = "Поиск противника...";
        for(var i = 0; i < dots % 4; i++)
          text = text + ".";
        ctx.fillText(text,rect.x + (rect.width - ctx.measureText(text1).width)/2, rect.y + rect.height*0.75);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text,rect.x + (rect.width - ctx.measureText(text1).width)/2, rect.y + rect.height*0.75);
        WaitTimeout5 = setTimeout('search()', 500);
      }
      function draw_bat(ctx, line_width1, line_width2, line_width3){  
        ctx.fillStyle = "#facc00";
        ctx.lineWidth = line_width1;
        roundRect(ctx, rect_10.x+line_width1/2, rect_10.y+line_width1/2, rect_10.width-line_width1, rect_10.height-line_width1, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        ctx.lineWidth = line_width2;
        roundRect(ctx, rect_50.x+line_width2/2, rect_50.y+line_width2/2, rect_50.width-line_width2, rect_50.height-line_width2, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        ctx.lineWidth = line_width3;
        roundRect(ctx, rect_100.x+line_width3/2, rect_100.y+line_width3/2, rect_100.width-line_width3, rect_100.height-line_width3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        ctx.font = 'bold '+bat_size+'px Helvetica, Arial';
        ctx.fillStyle = "purple";
        text = "10p";
        ctx.fillText(text,rect_10.x + (rect_10.width - ctx.measureText(text).width)/2, rect_10.y + rect_10.height/2 + bat_size/3);
        text1 = "50p";
        ctx.fillText(text1,rect_50.x + (rect_50.width - ctx.measureText(text1).width)/2, rect_50.y + rect_50.height/2 + bat_size/3);
        text2 = "100p";
        ctx.fillText(text2,rect_100.x + (rect_100.width - ctx.measureText(text2).width)/2, rect_100.y + rect_100.height/2 + bat_size/3);
        ctx.strokeStyle = "black";
        ctx.lineWidth = bat_size/20;
        ctx.strokeText(text,rect_10.x + (rect_10.width - ctx.measureText(text).width)/2, rect_10.y + rect_10.height/2 + bat_size/3);
        ctx.strokeText(text1,rect_50.x + (rect_50.width - ctx.measureText(text1).width)/2, rect_50.y + rect_50.height/2 + bat_size/3);
        ctx.strokeText(text2,rect_100.x + (rect_100.width - ctx.measureText(text2).width)/2, rect_100.y + rect_100.height/2 + bat_size/3);
      }
      function draw_forts(){
        if(forts_capture[0] == 0)
          ctx.drawImage(fort, fort1.x, fort1.y, fort_size.x, fort_size.y);
        if(forts_capture[0] == 1)
          ctx.drawImage(fort_red, fort1.x, fort1.y, fort_size.x, fort_size.y);
        if(forts_capture[0] == -1)
          ctx.drawImage(fort_blue, fort1.x, fort1.y, fort_size.x, fort_size.y);
        if(forts_capture[1] == 0)
          ctx.drawImage(fort,fort2.x, fort2.y, fort_size.x, fort_size.y);
        if(forts_capture[1] == 1)
          ctx.drawImage(fort_red, fort2.x, fort2.y, fort_size.x, fort_size.y);
        if(forts_capture[1] == -1)
          ctx.drawImage(fort_blue, fort2.x, fort2.y, fort_size.x, fort_size.y);
        if(forts_capture[2] == 0)  
          ctx.drawImage(fort,fort3.x, fort3.y, fort_size.x, fort_size.y);
        if(forts_capture[2] == 1)  
          ctx.drawImage(fort_red, fort3.x, fort3.y, fort_size.x, fort_size.y);
        if(forts_capture[2] == -1)  
          ctx.drawImage(fort_blue, fort3.x, fort3.y, fort_size.x, fort_size.y);
      }
      function Wait_duel_start(){
        if(Date.now() > start_time) {
          clearTimeout(WaitTimeout6);
          gamephase = 4;
          drawgame(2);
          return;
        }
        WaitTimeout6 = setTimeout('Wait_duel_start()', 50);
      }
      function drawgame(num_attack){
            ctx.lineWidth = 1;
            ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
            draw_balance(true);
            draw_forts();
            draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
            draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);
            if(num_attack == 1){
              fitst_attack();
              Waiter = 20;
              drawTimer();
            }
            if(num_attack == 2){
              //Wait_duel_start();
              //draw_opponent();
              fitst_attack();
              Waiter = 20;
              drawTimer();
            }
            if(num_attack == 10){
              go_n_soldiers();
            }
      }
      function go_n_soldiers(){  
        Waiter_collect = 4;
        var delta = 20;
        if (num_of_soldiers.blue > num_of_soldiers_current.red)
        {
            if (num_of_soldiers_current.red > num_of_soldiers.blue / 2)
              if (num_of_soldiers_current.red > num_of_soldiers.blue - 20)
                delta = num_of_soldiers.blue - num_of_soldiers_current.red;
            else if (num_of_soldiers_current.red < 20)
              delta = num_of_soldiers_current.red;
            if (Math.random() > 0.5)
              num_of_soldiers_current.blue = num_of_soldiers_current.red + Math.random() * delta;
            else if (Math.random() < 0.5 && Math.random() > 0.2)
              num_of_soldiers_current.blue = num_of_soldiers_current.red - Math.random() * delta;
            else if (Math.random() < 0.2 && Math.random() > 0.1)
              num_of_soldiers_current.blue = num_of_soldiers_current.red - Math.random() * (num_of_soldiers_current.red-1) + 1;
            else 
              num_of_soldiers_current.blue = num_of_soldiers_current.red + Math.random() * (num_of_soldiers.blue - num_of_soldiers_current.red);
        }
        else if (num_of_soldiers.blue < num_of_soldiers_current.red)
        {
          if (num_of_soldiers_current.red - 20 > num_of_soldiers.blue)
            num_of_soldiers_current.blue = Math.random() * num_of_soldiers.blue;
          else
          {
            if (num_of_soldiers.blue > 20)
              num_of_soldiers_current.blue = Math.random() * num_of_soldiers.blue;
            else if (Math.random() > 0.5)
              num_of_soldiers_current.blue = 1;
            else 
              num_of_soldiers_current.blue = Math.random() * num_of_soldiers.blue;
          }
        }
        else 
          num_of_soldiers_current.blue = Math.random() * num_of_soldiers.blue;
        soldiers_collect();
      }
      function Wait5sec(){
        if(Date.now() > start_seconds + 5000) {
          clearTimeout(WaitTimeout4);
          gamephase = 1;
          if(forts_capture[0] == 1 && forts_capture[1] == 1 && forts_capture[2] == 1)
          {
            gamephase = 0;
            bat = 0;
            start();
            return;
          }
          else if(forts_capture[0] == -1 && forts_capture[1] == -1 && forts_capture[2] == -1)
          {
            gamephase = 0;
            bat = 0;
            start();
            return;
          }
          drawgame(1);
          return;
        }
        WaitTimeout4 = setTimeout('Wait5sec()', 50);
      }  
      function win(){
        num_of_soldiers.red = num_of_soldiers.red + 20 - num_of_soldiers_current.red;
        num_of_soldiers.blue = num_of_soldiers.blue - num_of_soldiers_current.blue;
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        if(forts_capture[attack_on] == 0)
        {
          forts_capture[attack_on] = 1;
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы захватили башню!";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "(+20 войнов)";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        else if(forts_capture[attack_on] == 1)
        {
          if(forts_capture[0] != 1)
            forts_capture[0]++;
          else if(forts_capture[1] != 1)
            forts_capture[1]++;
          else if(forts_capture[2] != 1)
            forts_capture[2]++;
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight*0.7 + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*3, text_hight*14, text_hight*5, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы Зашитили башню!";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight*1.5);
          text2 = "Но там осталось мало места";
          ctx.fillStyle = "white";
          ctx.fillText(text2, canvas.width/2 - ctx.measureText(text2).width/2, canvas.height/2 - text_hight/2);
          text3 = "И вы пошли и отвоевали еще одну";
          ctx.fillStyle = "white";
          ctx.fillText(text3, canvas.width/2 - ctx.measureText(text3).width/2, canvas.height/2 + text_hight/2);
          text1 = "(+20 войнов)";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight*1.5);
        }
        else if(forts_capture[attack_on] == -1)
        {
          forts_capture[attack_on] = 0;
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы отвоевали башню башню!";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "(+20 войнов)";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        if(forts_capture[0] == 1 && forts_capture[1] == 1 && forts_capture[2] == 1)
        {
          clearScreen();
          ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы Победили!!!";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "Вы выиграли " + bat*2 + "р";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        start_seconds = Date.now();
        Wait5sec();
      }
      function lose(){
        
        num_of_soldiers.red = num_of_soldiers.red - num_of_soldiers_current.red;
        num_of_soldiers.blue = num_of_soldiers.blue + 20 - num_of_soldiers_current.blue;
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        if(forts_capture[attack_on] == 1)
        {
          forts_capture[attack_on] = 0;
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы проиграли сражение";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "Противник отвоевал башню";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        else{
          forts_capture[attack_on] = -1;
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы проиграли сражение";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "Башня отходит противнику";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        if(forts_capture[0] == -1 && forts_capture[1] == -1 && forts_capture[2] == -1)
        {
          clearScreen();
          ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
          draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
          draw_forts();
          draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);
          ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
          ctx.strokeStyle = "black";
          ctx.fillStyle = "#facc00";
          roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
          
          text = "Вы Проиграли";
          ctx.fillStyle = "white";
          ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
          text1 = "Попробуте еще раз";
          ctx.fillStyle = "white";
          ctx.fillText(text1, canvas.width/2 - ctx.measureText(text1).width/2, canvas.height/2 + text_hight/2);
        }
        start_seconds = Date.now();
        Wait5sec();
      }
      function draw()
      {
        num_of_soldiers.red = num_of_soldiers.red - num_of_soldiers_current.red;
        num_of_soldiers.blue = num_of_soldiers.blue - num_of_soldiers_current.blue;
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, 0, num_of_soldiers.blue);  
        draw_forts();
        draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, 0, num_of_soldiers.red);


        ctx.font = 'bold ' + text_hight + 'px Helvetica, Arial';
        ctx.strokeStyle = "black";
        ctx.fillStyle = "#facc00";
        roundRect(ctx, canvas.width/2 - text_hight*7, canvas.height/2 - text_hight*2, text_hight*14, text_hight*3, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        
        text = "Сражение кончилось ничьей";
        ctx.fillStyle = "white";
        ctx.fillText(text, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 - text_hight);
        text1 = "Никто ничего не захватил";
        ctx.fillStyle = "white";
        ctx.fillText(text1, canvas.width/2 - ctx.measureText(text).width/2, canvas.height/2 + text_hight/2);
        start_seconds = Date.now();
        Wait5sec();
      }
      function result(){
        if (num_of_soldiers_current.red > num_of_soldiers_current.blue)
          win();
        else if (num_of_soldiers_current.red < num_of_soldiers_current.blue)
          lose();
        else
          draw();
              
      }
      function battle(){
        Waiter_battle -= 1;
        if(Waiter_battle <= 0) {
          clearTimeout(WaitTimeout3);
          result();
          
          return;
        }
        var Waiter_battle_max = 0;
        if (num_of_soldiers_current.blue > num_of_soldiers_current.red)
          Waiter_battle_max = num_of_soldiers_current.red;
        else
          Waiter_battle_max = num_of_soldiers_current.blue;
        
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, num_of_soldiers_current.blue, num_of_soldiers.blue);  
        var delta_size = big_soldier_blue.size_x/(big_soldier_blue.size_x+big_soldier_red.size_x)
        var delta_size1 = big_soldier_red.size_x/(big_soldier_blue.size_x+big_soldier_red.size_x)
        if(delta_size > 0.5)
        {
          delta_size1 = delta_size1 / delta_size;
          delta_size = 1
        }
        else
        {
          delta_size = delta_size / delta_size1;
          delta_size1 = 1
        }
          
        var size_xx = big_soldier_blue.size_x - ((big_soldier_blue.size_x - blue_army.size)*((Waiter_battle_max-Waiter_battle)/Waiter_battle_max))*delta_size1;
        var size_yy = big_soldier_blue.size_y - ((big_soldier_blue.size_y - blue_army.size/7*11)*((Waiter_battle_max-Waiter_battle)/Waiter_battle_max))*delta_size1;
        ctx.drawImage(warrior_blue, big_soldier_blue.x+(big_soldier_blue.size_x - size_xx)/2, big_soldier_blue.y +(big_soldier_blue.size_y - size_yy), size_xx, size_yy);

        draw_forts();
        draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, num_of_soldiers_current.red, num_of_soldiers.red);
        
        size_xx = big_soldier_red.size_x - ((big_soldier_red.size_x - red_army.size)*((Waiter_battle_max-Waiter_battle)/Waiter_battle_max))*delta_size;
        size_yy = big_soldier_red.size_y - ((big_soldier_red.size_y - red_army.size/7*11)*((Waiter_battle_max-Waiter_battle)/Waiter_battle_max))*delta_size;
        ctx.drawImage(warrior_red, big_soldier_red.x+(big_soldier_red.size_x - size_xx)/2, big_soldier_red.y+(big_soldier_red.size_y - size_yy), size_xx, size_yy);
        for (var i = 0; i < Waiter_battle_max-Waiter_battle; i++){
            ctx.drawImage(warrior_blue, big_soldier_blue.x + (big_soldier_blue.size_x - size_xx)/2 + angles_x[i%13] * ((Waiter_battle_max - Waiter_battle)-i), big_soldier_blue.y + (big_soldier_blue.size_y - size_yy)+ angles_y[i%13] * ((Waiter_battle_max - Waiter_battle)-i), blue_army.size, blue_army.size/7*11);
            ctx.drawImage(warrior_red, big_soldier_blue.x + (big_soldier_red.size_x - size_xx)/2 + angles_x[13-i%13] * ((Waiter_battle_max - Waiter_battle)-i), big_soldier_blue.y + (big_soldier_blue.size_y - size_yy)+ angles_y[13-i%13] * ((Waiter_battle_max - Waiter_battle)-i), blue_army.size, blue_army.size/7*11);
        }
        
        WaitTimeout3 = setTimeout('battle()', 60);
      }
      function attack(){
        Waiter_attack -= 0.05;
        if(Waiter_attack <= 0) {
          clearTimeout(WaitTimeout2);
          if (num_of_soldiers_current.blue > 10 && num_of_soldiers_current.red > 10)
          {
            if (num_of_soldiers_current.blue > num_of_soldiers_current.red)
              Waiter_battle = num_of_soldiers_current.red;
            else
              Waiter_battle = num_of_soldiers_current.blue;
            battle();
          }
          else{
            result();
          }
          return;
        }
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_balance(false);
        Dx = 0; Dy = 0; x1 = 0; y1 = 0; Dxy = 0; x_c = 0; y_c = 0; c_sum = 0;
        var num_of_soldiers_i = 0;
        draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, num_of_soldiers_current.blue, num_of_soldiers.blue);      
        big_soldier_blue.size_x = blue_army.size * (1 + blue_soldier_size/20);
        big_soldier_blue.size_y = blue_army.size/7*11 * (1 + blue_soldier_size/20);
        if(attack_on == 2){
          end_point.x = fort3.x;
          end_point.y = fort3.y;
        }else if (attack_on == 1){
          end_point.x = fort2.x;
          end_point.y = fort2.y;
        }else if (attack_on == 0){
          end_point.x = fort1.x;
          end_point.y = fort1.y;
        }
        Dx = end_point.x - (blue_army.x + 5*(BackGroundSizeX/15) - big_soldier_blue.size_x/2 + big_soldier_blue.size_x/7);
        Dy = end_point.y + fort_size.y - big_soldier_blue.size_y - (blue_army.y + (BackGroundSizeY/35)*3 - big_soldier_blue.size_y);
        big_soldier_blue.x = blue_army.x + 5*(BackGroundSizeX/15) - big_soldier_blue.size_x/2 + big_soldier_blue.size_x/7 + Dx*(1-Waiter_attack/4);
        big_soldier_blue.y = blue_army.y + (BackGroundSizeY/35)*3 - big_soldier_blue.size_y + Dy*(1-Waiter_attack/4);
        ctx.drawImage(warrior_blue, big_soldier_blue.x, big_soldier_blue.y, big_soldier_blue.size_x, big_soldier_blue.size_y);
        draw_forts();
        var Dx = 0, Dy = 0, x1 = 0, y1 = 0, Dxy = 0, x_c = 0, y_c = 0, c_sum = 0;
        var num_of_soldiers_i = 0;
        
        draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, num_of_soldiers_current.red, num_of_soldiers.red);        
        big_soldier_red.size_x = red_army.size * (1 + red_soldier_size/20);
        big_soldier_red.size_y = red_army.size/7*11 * (1 + red_soldier_size/20);
        Dx = end_point.x - (red_army.x + 5*(BackGroundSizeX/15) - big_soldier_red.size_x/2 + big_soldier_red.size_x/7);
        Dy = end_point.y + fort_size.y - big_soldier_red.size_y - (red_army.y + (BackGroundSizeY/35) - big_soldier_red.size_y);
        
        big_soldier_red.x = red_army.x + 5*(BackGroundSizeX/15) - big_soldier_red.size_x/2 + big_soldier_red.size_x/7 + Dx*(1-Waiter_attack/4);
        big_soldier_red.y = red_army.y + (BackGroundSizeY/35) - big_soldier_red.size_y + Dy*(1-Waiter_attack/4);

        ctx.drawImage(warrior_red, big_soldier_red.x, big_soldier_red.y, big_soldier_red.size_x, big_soldier_red.size_y); 
        ctx.font = 'bold '+(num_of_soldiers_current.red/2+15)+'px Helvetica, Arial';
        ctx.fillStyle = "white";
        ctx.fillText(num_of_soldiers_current.red, red_army.x + 5*(BackGroundSizeX/15) - ctx.measureText(num_of_soldiers_current.red).width/2 + Dx*(1-Waiter_attack/4), red_army.y + (BackGroundSizeY/35) - big_soldier_red.size_y/5 + Dy*(1-Waiter_attack/4));
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        ctx.strokeText(num_of_soldiers_current.red, red_army.x + 5*(BackGroundSizeX/15) - ctx.measureText(num_of_soldiers_current.red).width/2 + Dx*(1-Waiter_attack/4), red_army.y + (BackGroundSizeY/35) - big_soldier_red.size_y/5 + Dy*(1-Waiter_attack/4));

        WaitTimeout2 = setTimeout('attack()', 50);
      }
      function soldiers_collect(){
        Waiter_collect -= 0.05;
        if(Waiter_collect <= 0) {
          clearTimeout(WaitTimeout1);
          Waiter_attack = 4;
          attack();
          return;
        }
        clearScreen();
        ctx.drawImage(pool,BackGroundX,BackGroundY, BackGroundSizeX, BackGroundSizeY);
        draw_forts();
        draw_balance(false);
        var Dx = 0, Dy = 0, x1 = 0, y1 = 0, Dxy = 0, x_c = 0, y_c = 0, c_sum = 0;
        var num_of_soldiers_i = 0;
        draw_n_soldiers_red(red_army.x, red_army.y, red_army.size, num_of_soldiers_current.red, num_of_soldiers.red);
        for (step1 = 0; step1 < num_of_soldiers.red/10; step1+=1){
          for (step = 0; step < 10; step+=1){
            x1 = red_army.x + step*(BackGroundSizeX/15);
            y1 = red_army.y + step1*(BackGroundSizeY/35);
            num_of_soldiers_i++;
            if(num_of_soldiers_i <= num_of_soldiers_current.red)
            {
              Dx = (4.5-step)*(BackGroundSizeX/15);
              Dy = -step1*(BackGroundSizeY/35);
              Dxy = Math.abs(Dx) + Math.abs(Dy);
              x_c = x1 + (BackGroundSizeX/5)*(4-Waiter_collect)*(Dx/Dxy);
              y_c = y1 + (BackGroundSizeX/5)*(4-Waiter_collect)*(Dy/Dxy);
              if(Math.abs(red_army.x + 4.5*(BackGroundSizeX/15)-x1) < Math.abs(x1-x_c) + 20)
                c_sum++;
              else
                ctx.drawImage(warrior_red, x_c, y_c, red_army.size, red_army.size/7*11);
            }
          }
        }        
        red_soldier_size = c_sum;
        var big_soldier_size_x = red_army.size * (1 + red_soldier_size/20);
        var big_soldier_size_y = red_army.size/7*11 * (1 + red_soldier_size/20);
        ctx.drawImage(warrior_red,red_army.x + 5*(BackGroundSizeX/15) - big_soldier_size_x/2 + big_soldier_size_x/7, red_army.y + (BackGroundSizeY/35) - big_soldier_size_y, big_soldier_size_x, big_soldier_size_y); 
     
        Dx = 0; Dy = 0; x1 = 0; y1 = 0; Dxy = 0; x_c = 0; y_c = 0;c_sum = 0;
        var num_of_soldiers_i = 0;
        draw_n_soldiers_blue(blue_army.x, blue_army.y, blue_army.size, num_of_soldiers_current.blue, num_of_soldiers.blue);
        for (step1 = 0; step1 < parseInt(num_of_soldiers.blue/10); step1+=1){
          for (step = 0; step < 10; step+=1){
            x1 = blue_army.x + step*(BackGroundSizeX/15);
            y1 = blue_army.y - parseInt(num_of_soldiers.blue/10)*(BackGroundSizeY/35)+ step1*(BackGroundSizeY/35);
            num_of_soldiers_i++;
            if(num_of_soldiers_i > num_of_soldiers.blue - num_of_soldiers_current.blue)
            {
              Dx = (4.5-step)*(BackGroundSizeX/15);
              Dy = (parseInt(num_of_soldiers.blue/10+1)-step1)*(BackGroundSizeX/35);
              Dxy = Math.abs(Dx) + Math.abs(Dy);
              x_c = x1 + (BackGroundSizeX/5)*(4-Waiter_collect)*(Dx/Dxy);
              y_c = y1 + (BackGroundSizeX/5)*(4-Waiter_collect)*(Dy/Dxy);
              if(Math.abs(blue_army.x + 4.5*(BackGroundSizeX/15)-x1) < Math.abs(x1-x_c) + 20)
                c_sum++;
              else
                ctx.drawImage(warrior_blue, x_c, y_c, blue_army.size, blue_army.size/7*11);
            }
          }
        }        
        blue_soldier_size = c_sum;
        var big_soldier_size_x = red_army.size * (1 + blue_soldier_size/20);
        var big_soldier_size_y = red_army.size/7*11 * (1 + blue_soldier_size/20);
        ctx.drawImage(warrior_blue,blue_army.x + 4.5*(BackGroundSizeX/15) - big_soldier_size_x/2 + big_soldier_size_x/7, blue_army.y + (BackGroundSizeY/35)*3 - big_soldier_size_y, big_soldier_size_x, big_soldier_size_y);
        WaitTimeout1 = setTimeout('soldiers_collect()', 50);
      }
      function fitst_attack(){
        ctx.lineWidth = bat_size/20;
        ctx.font = 'bold '+ BackGroundSizeX/14+'px Helvetica, Arial';
        ctx.fillStyle = "#facc00";
        roundRect(ctx, rect_attack.x, rect_attack.y, rect_attack.width, rect_attack.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        
        text = "Сражение через"
        ctx.fillStyle = "white";
        ctx.fillText(text,rect_attack.x + rect_attack.width*0.02, rect_attack.y + rect_attack.height/2+canvas.height/70);

        update_num(canvas.width/2);
        if(forts_capture[2] == 0 || (forts_capture[0] == -1 && forts_capture[1] == -1 && forts_capture[2] == 1) || (forts_capture[0] == -1 && forts_capture[1] == 1 && forts_capture[2] == 1)){
          ctx.drawImage(arrow_rigth,canvas.width/2+40,canvas.height/2 + fort_size.y/3, BackGroundSizeX/3, red_army.y - canvas.height/2 - fort_size.y/3);
          attack_on = 2;
        }
        else if(forts_capture[1] == 0 || (forts_capture[0] == -1 && forts_capture[1] == 1 && forts_capture[2] == -1) || (forts_capture[0] == 1 && forts_capture[1] == 1 && forts_capture[2] == -1)){ 
          ctx.drawImage(arrow_forward,canvas.width/2-BackGroundSizeX/6,canvas.height/2 + fort_size.y/3, BackGroundSizeX/3, red_army.y - canvas.height/2 - fort_size.y/3);
          attack_on = 1;
        }
        else if(forts_capture[0] == 0 || (forts_capture[0] == 1 && forts_capture[1] == -1 && forts_capture[2] == -1)){ 
          ctx.drawImage(arrow_left,canvas.width/2-40-BackGroundSizeX/3,canvas.height/2 + fort_size.y/3, BackGroundSizeX/3, red_army.y - canvas.height/2 - fort_size.y/3);
          attack_on = 0;
        }
      }
      function update_num(mousePositionX){

        ctx.lineWidth = bat_size/20;
        ctx.fillStyle = "#facc00";
        roundRect(ctx, rect_num_of_soldiers.x, rect_num_of_soldiers.y, rect_num_of_soldiers.width, rect_num_of_soldiers.height, {tl: border_size, br: border_size, tr:border_size, bl:border_size}, true);
        ctx.font = 'bold '+ BackGroundSizeX/16+'px Helvetica, Arial';
        text = "Выберите размер отряда"
        ctx.fillStyle = "white";
        ctx.fillText(text,rect_num_of_soldiers.x + rect_num_of_soldiers.width*0.02, rect_num_of_soldiers.y + rect_num_of_soldiers.height*0.25);
        ctx.strokeStyle =  "#facc00";
        ctx.fillStyle = "#facc00";
        ctx.font = 'bold '+ BackGroundSizeX/13+'px Helvetica, Arial';
        num_of_soldiers_current.red = parseInt(((mousePositionX - slider_soldiers.x)*num_of_soldiers.red)/slider_soldiers.width+1);
        text = num_of_soldiers_current.red;
        ctx.fillStyle = "black";
        ctx.fillText(text,rect_num_of_soldiers.x + rect_num_of_soldiers.width*0.85, rect_num_of_soldiers.y + rect_num_of_soldiers.height*0.7);
        ctx.beginPath();
        ctx.rect(slider_soldiers.x, slider_soldiers.y+slider_soldiers.height/3, slider_soldiers.width, slider_soldiers.height/3);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(mousePositionX, slider_soldiers.y+slider_soldiers.height/2, slider_soldiers.height/3, 0, 360, false);  
        ctx.fill();
        ctx.beginPath();
        ctx.strokeStyle = "grey";
        ctx.arc(mousePositionX, slider_soldiers.y+slider_soldiers.height/2, slider_soldiers.height/3, 0, 360, false);  
        ctx.stroke();
        
      }
      function drawTimer() {
            Waiter -= 0.05;
            if(Waiter <= 0) {
                //clearTimeout(WaitTimeout);
                gamephase = 2;
                drawgame(10);
                return;
            }
            ctx.lineWidth = 2;
            ctx.strokeStyle =  "#facc00";
            ctx.fillStyle = "#facc00";
            ctx.beginPath();
            ctx.arc(Timer_pos.x, Timer_pos.y, Timer_size, 0, 360, false);
            ctx.stroke();
            ctx.fill();
            ctx.lineWidth = canvas.height/40;
            ctx.strokeStyle =  "black";
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(Timer_pos.x, Timer_pos.y, Timer_size*0.8, -Math.PI/2+((20-Waiter)/20)*Math.PI*2, Math.PI*3/2, false);
            ctx.stroke();


            ctx.fillStyle = "black";
            ctx.font = 'bold '+canvas.height/20+'px Helvetica, Arial';
            var text = Math.trunc(Waiter+0.8) 
            ctx.fillText(text, Timer_pos.x - ctx.measureText(text).width / 2, Timer_pos.y + canvas.height/60);
            WaitTimeout = setTimeout('drawTimer()', 50);
            
        }
      function getMousePos(canvas, event){
        var rect = canvas.getBoundingClientRect();
        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top
        };
      }
      function isInside(pos, rect){
          return pos.x > rect.x && pos.x < rect.x+rect.width && pos.y < rect.y+rect.height && pos.y > rect.y
      }
      canvas.addEventListener('click', function(evt){
        var mousePos = getMousePos(canvas, evt);
        if (isInside(mousePos,rect)) 
        {
          if(gamephase == 0 && bat != 0)
          {
            //drawgame(1);
            start_seconds = Date.now();
            start_search();
            search();
            gamephase = 3;
          }
        }
        if (isInside(mousePos,rect_single)) 
        {
          if(gamephase == 0 && bat != 0)
          {
            drawgame(1);
            gamephase = 1;
          }
          if(gamephase == 3)
          {
            start();
            clearTimeout(WaitTimeout5);
            gamephase = 0;
          }
        }
        if (isInside(mousePos,rect_10)) 
        {
          if(gamephase == 0)
          {
            bat = 10;
            draw_bat(ctx, parseInt(bat_size/20)*4, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2);
          }
        }
        if (isInside(mousePos,rect_50)) 
        {
          if(gamephase == 0)
          {
            bat = 50;
            draw_bat(ctx, parseInt(bat_size/20)*2, parseInt(bat_size/20)*4, parseInt(bat_size/20)*2);
          }
        }
        if (isInside(mousePos,rect_100)) 
        {
          if(gamephase == 0)
          {
            bat = 100;
            draw_bat(ctx, parseInt(bat_size/20)*2, parseInt(bat_size/20)*2, parseInt(bat_size/20)*4);
          }
        }
        if (isInside(mousePos,slider_soldiers)) 
        {
          if(gamephase == 1 || gamephase == 4)
          {
            update_num(mousePos.x)
          }
        }
      }, false);
        
      
      
		</script>
	</body>
</html>